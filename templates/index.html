<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VNES AI - H·ªèi k√®m h√¨nh ·∫£nh</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

  <div class="max-w-2xl mx-auto mt-12 p-8 bg-white rounded-xl shadow-lg">

    <!-- üñºÔ∏è Logo VNES -->
    <div class="flex items-center justify-center mb-4">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="VNES Logo" class="h-16 mr-3" />
      <h1 class="text-3xl font-bold text-indigo-700">VNES AI</h1>
    </div>

    <h2 class="text-xl font-semibold text-center text-gray-600 mb-6">üéØ H·ªèi VNES AI b·∫±ng h√¨nh ·∫£nh (t√πy ch·ªçn)</h2>

    <form id="askForm" enctype="multipart/form-data" class="space-y-4">
      <div>
        <label for="question" class="block font-semibold mb-1">C√¢u h·ªèi:</label>
        <input type="text" name="question" id="question" required
               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
               placeholder="Nh·∫≠p c√¢u h·ªèi t·∫°i ƒë√¢y..." />
      </div>

      <div>
        <label for="image" class="block font-semibold mb-1">T·∫£i h√¨nh ·∫£nh l√™n (kh√¥ng b·∫Øt bu·ªôc):</label>
        <input type="file" name="image" id="image" accept="image/*"
               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none file:bg-indigo-500 file:text-white file:font-semibold file:px-4 file:py-2 file:rounded file:mr-4" />
      </div>

      <div>
        <label for="ai" class="block font-semibold mb-1">Ch·ªçn AI:</label>
        <select name="ai" id="ai" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="vnes_ai">VNES AI</option>
          <option value="deepseek">DeepSeek</option>
          <option value="openrouter">ChatGPT (OpenRouter)</option>
        </select>
      </div>

      <button type="submit"
              class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200 w-full">
        üöÄ G·ª≠i c√¢u h·ªèi
      </button>
    </form>

    <div id="result" class="mt-6 p-4 bg-gray-50 border rounded-lg hidden">
      <div class="flex justify-between items-center mb-2">
        <h2 id="answerSource" class="text-lg font-semibold text-indigo-500">üß† Tr·∫£ l·ªùi t·ª´:</h2>
        <button id="copyButton" class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold py-1 px-3 rounded-lg transition duration-200 hidden">
          üìã Sao ch√©p
        </button>
      </div>
      <img id="answerImage" class="max-w-full rounded-lg mb-3 hidden" alt="·∫¢nh tr·∫£ l·ªùi" />
      <p id="answerText" class="whitespace-pre-line text-gray-700"></p>
    </div>
  </div>

  <script>
    const form = document.getElementById('askForm');
    const answerText = document.getElementById('answerText');
    const answerImage = document.getElementById('answerImage');
    const resultBox = document.getElementById('result');
    const answerSource = document.getElementById('answerSource');
    const copyButton = document.getElementById('copyButton');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Hi·ªán tr·∫°ng th√°i loading
      answerText.textContent = "‚è≥ ƒêang g·ª≠i c√¢u h·ªèi...";
      answerImage.classList.add("hidden");
      copyButton.classList.add("hidden"); // ·∫®n n√∫t sao ch√©p khi ƒëang t·∫£i
      resultBox.classList.remove("hidden");

      const formData = new FormData(form);
      const selectedAI = document.getElementById('ai').value;

      // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ ngu·ªìn tr·∫£ l·ªùi d·ª±a tr√™n AI ƒë∆∞·ª£c ch·ªçn
      answerSource.textContent = `üß† Tr·∫£ l·ªùi t·ª´ ${selectedAI === 'vnes_ai' ? 'VNES AI' : selectedAI === 'deepseek' ? 'DeepSeek' : 'ChatGPT (OpenRouter)'}:`;

      try {
        const res = await fetch('/ask-image', {
          method: 'POST',
          body: formData
        });

        const contentType = res.headers.get("content-type");

        if (contentType && contentType.includes("image")) {
          // N·∫øu backend tr·∫£ v·ªÅ ·∫£nh (v√≠ d·ª• ·∫£nh ƒë√°p √°n To√°n)
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          answerImage.src = url;
          answerImage.classList.remove("hidden");
          answerText.textContent = "";
          copyButton.classList.remove("hidden");
          copyButton.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t sao ch√©p cho h√¨nh ·∫£nh
          copyButton.textContent = "üìã Kh√¥ng th·ªÉ sao ch√©p ·∫£nh";
        } else if (contentType && contentType.includes("application/json")) {
          // N·∫øu backend tr·∫£ v·ªÅ JSON
          const data = await res.json();
          answerImage.classList.add("hidden");

          if (res.ok) {
            answerText.textContent = data.answer || "‚úÖ ƒê√£ nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi.";
            answerSource.textContent = `üß† Tr·∫£ l·ªùi t·ª´ ${data.ai === 'vnes_ai' ? 'VNES AI' : data.ai === 'deepseek' ? 'DeepSeek' : 'ChatGPT (OpenRouter)'}:`;
            copyButton.classList.remove("hidden");
            copyButton.disabled = false;
            copyButton.textContent = "üìã Sao ch√©p";
            form.reset(); // Reset form sau khi g·ª≠i th√†nh c√¥ng
          } else {
            answerText.textContent = `‚ùå L·ªói: ${data.error || "Kh√¥ng r√µ nguy√™n nh√¢n."}`;
            copyButton.classList.add("hidden");
          }
        } else {
          // Tr∆∞·ªùng h·ª£p kh√°c
          answerText.textContent = "‚ùå ƒê√£ nh·∫≠n ph·∫£n h·ªìi kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng. Vui l√≤ng ki·ªÉm tra log.";
          answerImage.classList.add("hidden");
          copyButton.classList.add("hidden");
        }

      } catch (err) {
        answerText.textContent = `‚ùå ƒê√£ x·∫£y ra l·ªói: ${err.message || "K·∫øt n·ªëi th·∫•t b·∫°i."}`;
        answerImage.classList.add("hidden");
        copyButton.classList.add("hidden");
      }
    });

    // X·ª≠ l√Ω s·ª± ki·ªán sao ch√©p
    copyButton.addEventListener('click', () => {
      if (answerImage.classList.contains("hidden")) {
        // N·∫øu l√† text, sao ch√©p n·ªôi dung
        const textToCopy = answerText.textContent;
        navigator.clipboard.writeText(textToCopy).then(() => {
          copyButton.textContent = "‚úÖ ƒê√£ sao ch√©p!";
          setTimeout(() => {
            copyButton.textContent = "üìã Sao ch√©p";
          }, 2000); // Tr·ªü l·∫°i tr·∫°ng th√°i ban ƒë·∫ßu sau 2 gi√¢y
        }).catch(err => {
          copyButton.textContent = "‚ùå L·ªói sao ch√©p";
          console.error("L·ªói sao ch√©p:", err);
        });
      } else {
        // N·∫øu l√† h√¨nh ·∫£nh, kh√¥ng l√†m g√¨ (n√∫t ƒë√£ b·ªã v√¥ hi·ªáu h√≥a)
        return;
      }
    });
  </script>
</body>
</html>
